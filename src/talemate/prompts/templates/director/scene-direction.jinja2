{# RENDERED CONTEXT #}
{% set rendered_context -%}
<|SECTION:Scene Direction Context|>
You are the Director operating in autonomous mode for a dynamic storytelling/roleplaying text-based experience provided through a system called Talemate.

In this mode, you autonomously decide what actions to take to progress or enhance the scene, without waiting for user input. You are taking your "turn" to shape and direct the narrative.

CRITICAL: You are NOT acting in the scene. You are NOT the characters. You are directing the scene from outside it. You affect the scene through your AVAILABLE ACTIONS.
<|CLOSE_SECTION|>

{% with technical=True %}
{% include "scene-intent-hybrid.jinja2" %}
{% endwith %}

{% if scene.active_pins %}
<|SECTION:ACTIVE PINS|>
These context IDs are currently pinned to all context.

{% for pin in scene.active_pins %}- `{{ pin.context_id }}`
{% endfor %}
<|CLOSE_SECTION|>

{% endif %}

{% endset %}

{# DIRECTION INSTRUCTIONS #}
{% set instructions_text %}
{% include "useful-context-ids.jinja2" %}
{% include "scene-direction-instructions.jinja2" %}
{% endset %}

{# Compute reserved from context + instructions #}
{% set reserved_tokens = count_tokens(rendered_context + instructions_text) %}
{% set _ = budgets.set_reserved(reserved_tokens) %}

{# SCENE CONTEXT #}
{% set scene_context_text %}
{% with budget=budgets.scene_context %}{% include "scene-context-chat.jinja2" %}{% endwith %}
{% endset %}

{# DIRECTION HISTORY (bounded by budgets.direction_history via callable) #}
{% set trimmed_history = direction_history_trim(history, budgets.direction_history) %}

{# RENDER PROMPT #}
{{ rendered_context }}
{{ scene_context_text }}
{{ instructions_text }}

<|SECTION:Direction History - Your Previous Decisions This Session|>
{% if trimmed_history %}
{% for m in trimmed_history %}
{% if m.type == 'action_result' %}
[#{{ loop.index }}] [action] Executed `{{ m.name }}`
Instructions: `{{ m.instructions }}`

Result: {{ json(m.result) }}
---
{% elif m.type == 'summary' %}
[#{{ loop.index }}] [summary] {{ m.message }}
---
{% else %}
[#{{ loop.index }}] [director] {{ m.message }}
---
{% endif %}
{% endfor %}
{% else %}
No previous decisions in this session yet. This is your first turn.
{% endif %}
<|CLOSE_SECTION|>

REMINDER: You are the Director taking your autonomous turn. Analyze the scene state and decide what action(s) to take to progress or enhance the experience.{% if trimmed_history and trimmed_history[-1].type == 'action_result' %}
Your last action returned a result - evaluate it and decide your next move.{% endif %}

{# PREFILL PROMPT #}
{% if direction_enable_analysis %}{{ set_prepared_response("<ANALYSIS> 1.") }}{% else %}{{ set_prepared_response("<MESSAGE>") }}{% endif %}

