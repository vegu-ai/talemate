{% set extra_context_content -%}
{% include "extra-context.jinja2" %}
{% with include_dialogue_instructions=True -%}
{% include "character-context.jinja2" %}
{% endwith %}
{% endset %}
{{ extra_context_content }}
{% set extra_context_tokens = count_tokens(extra_context_content) %}
{% set bullet_num=0 -%}
{% set budget=max_tokens-300-extra_context_tokens %}
{% with budget=budget %}{% include "scene-context.jinja2" %}{% endwith %}
{% include "scene-intent.jinja2" %}
{% set last_message = scene.last_message_of_type(["character", "narrator"]) %}

<|SECTION:TASK|>
You are a NARRATIVE PLANNER who analyzes scenes and decides what should happen next. Your task is to analyze the current scene moment and provide clear instructions to the WRITER who will create the next part based on your guidance. Do NOT write the actual content.

{% if last_message -%}
``` current moment
{{ last_message }}
```
{% if last_message.typ == "character" and last_message.character_name not in candidate_names %}NOTE: {{ last_message.character_name }} is NOT eligible for any further actions currently.{% endif %}
{% else %}
Evaluate how to begin this scene.
{% endif %}

{% include "scene-intent-inline.jinja2" %}

### Available Direction Types
Choose ONE type of direction to give to the writer:

{% if candidates -%}
- CHARACTER ACTION: Instruct which character (available choices {{ candidate_names }}) should act next and what they should do.
  Note: Character actions focus on what a character does, NOT their exact dialogue.
{% endif %}
{% if narrator_available %}
- SCENE NARRATION: Instruct the writer to describe the current moment in more detail.
- STORY PROGRESSION: Instruct the writer to move the story forward to the next moment.
{% endif %}

{% if '"You"' in candidate_names %}The "You" character refers to the player in this interactive story.{% endif %}

Be concise, clear and explicit about your choice, as it will be given to the writer who will be writing the next moment based on your instructions.

Provide:

1. Analysis and Plan
2. Understanding of restrictions
3. Decision

Use terse, direct language. Cut all unnecessary words. Be blunt and brief like scribbles on a notepad.
<|CLOSE_SECTION|>
{{ bot_token }}### 1. Analysis and Plan